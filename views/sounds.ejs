<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/style.css" />
  </head>

  <body>
    <%- include("partials/navbar") %>

    <main
      class="min-h-[81vh] flex flex-col items-center gap-10 first-bg sm:p-6 p-2 text-dark">
      <!-- Upload Section -->
      <div class="btn w-full flex items-center justify-end gap-3">
        <!-- Upload Button -->
        <button
          id="uploadBtn"
          class="flex justify-center items-center w-14 h-14 div-bg rounded-full">
          <img class="w-7 icon" src="/images/plus.png" alt="" />
        </button>

        <!-- Upload Form -->
        <form
          id="uploadForm"
          action="/upload-audio"
          method="POST"
          enctype="multipart/form-data"
          class="flex items-center gap-3">
          <input
            type="text"
            name="name"
            placeholder="Enter audio name"
            class="input p-2 rounded-md"
            required />

          <input
            type="file"
            name="audio"
            id="audioInput"
            accept="audio/*"
            class="hidden" />
        </form>
      </div>

      <!-- Notes Table -->
      <table
        id="fileTable"
        class="border-collapse border border-gray-400 rounded-md w-full">
        <tr>
          <th class="border border-gray-400 p-2">Audio</th>
          <th class="border border-gray-400 p-2">Name</th>
          <th class="border border-gray-400 p-2">Date</th>
        </tr>

        <% audios.forEach((audio, idx) => { %>
        <tr class="text-dark">
          <td class="border border-gray-400 sm:px-2 px-0 py-2 text-center">
            <audio controls class="w-full sm:w-32">
              <source src="/<%=audio.filePath%>" type="audio/mpeg" />
              Your browser does not support the audio element.
            </audio>
          </td>

          <td
            class="flex items-center justify-center gap-3 border border-gray-400 sm:px-2 px-0 py-2 text-center">
            <span class="font-lg"><%= audio.name %></span>
            <img
              src="/images/delete.png"
              id="<%= audio._id %>"
              class="delete sm:w-4 w-3 cursor-pointer a opacity-30 hover:opacity-100 hover:text-red-600 transition-all duration-300"
              title="Delete Audio" />
          </td>

          <td class="border border-gray-400 sm:px-2 px-0 py-2 text-center">
            <%= audio.createdAt.toLocaleDateString() %>
          </td>
        </tr>
        <% }) %>
      </table>
    </main>

    <%- include("partials/footer") %>

    <script>
      const uploadBtn = document.getElementById("uploadBtn");
      const audioInput = document.getElementById("audioInput");
      const uploadForm = document.getElementById("uploadForm");
      const deletes = document.querySelectorAll(".delete");

      uploadBtn.addEventListener("click", () => audioInput.click());

      audioInput.addEventListener("change", () => {
        if (audioInput.files.length > 0) {
          uploadForm.submit();
        }
      });

      deletes.forEach((del) => {
        del.addEventListener("click", async (e) => {
          if (confirm("Are you sure you want to delete this audio?")) {
            let id = e.target.id;
            await fetch(`/audios-delete/${id}`, { method: "POST" });
            location.reload();
          }
        });
      });

      // Keep theme support
      const isDarkTheme = localStorage.getItem("theme") === "dark";
      document.querySelectorAll("audio").forEach((audio) => {
        if (isDarkTheme) audio.classList.add("invert");
        else audio.classList.remove("invert");
      });
    </script>
  </body>
</html>
