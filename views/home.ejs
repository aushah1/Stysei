<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Study</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body class="text-dark">
    <%- include("partials/navbar") %>

    <div
      class="hero text-dark w-full flex justify-center items-center relative first-bg sm:h-[60vh] h-[50vh]">
      <h1
        id="quote"
        class="w-[80%] text-center lg:text-7xl sm:text-5xl text-3xl">
        <!-- Small steps , big dreams. Every minute counts! -->
      </h1>
      <img
        class="sm:w-10 w-8 absolute top-[70%] left-[5%] rotate-[20deg]"
        src="/images/book.png"
        alt="" />
      <img
        class="sm:w-20 w-16 absolute top-[70%] left-[80%] -rotate-45"
        src="/images/open-book.png"
        alt="" />
      <img
        class="sm:w-10 w-8 absolute top-[10%] left-[10%]"
        src="/images/star-p.png"
        alt="" />
      <img
        class="sm:w-10 w-8 absolute top-[10%] left-[60%]"
        src="/images/star-p.png"
        alt="" />
      <img
        class="sm:w-10 w-8 absolute top-[30%] left-[90%]"
        src="/images/star-p.png"
        alt="" />
      <img
        class="sm:w-10 w-8 absolute top-[80%] left-[50%]"
        src="/images/star-p.png"
        alt="" />
      <img
        class="w-6 absolute top-[70%] left-[20%]"
        src="/images/mini-str.png"
        alt="" />
      <img
        class="w-6 absolute top-[5%] left-[80%]"
        src="/images/mini-str.png"
        alt="" />
      <img
        class="w-6 absolute top-[10%] left-[40%]"
        src="/images/mini-str.png"
        alt="" />
    </div>
    <main
      class="grid text-dark lg:grid-cols-2 grid-cols-1 lg:gap-4 gap-20 px-6 py-10 place-items-center second-bg">
      <div
        class="total p-8 home-div rounded-md flex items-center justify-center shadow-[0_4px_10px_16px_rgba(255,255,255,0.25)]">
        <div
          class="circle shadow-[0_4px_10px_10px_rgba(255,255,255,0.25)] p-10 flex flex-col items-center justify-start gap-10 md:w-[23rem] md:h-[23rem] sm:w-80 sm:h-80 w-60 h-60 rounded-full border-[12px] second-bg">
          <h5 class="md:text-6xl sm:text-5xl text-3xl text-dark text-center">
            Total Time
          </h5>
          <h3 id="totalTime" class="md:text-8xl sm:text-7xl text-5xl text-dark">
            00:00
          </h3>
        </div>
      </div>
      <div class="last flex flex-col justify-center items-center gap-10">
        <div class="apps flex justify-center items-center gap-6">
          <div
            class="app sm:w-20 sm:h-20 w-14 h-14 flex items-center justify-center cursor-pointer home-div rounded-full shadow-md">
            <a href="/tasks">
              <img
                class="icon sm:w-12 w-8 invert"
                src="/images/checklist.png"
                alt=""
            /></a>
          </div>
          <div
            class="app sm:w-20 sm:h-20 w-14 h-14 flex items-center justify-center cursor-pointer home-div rounded-full shadow-md">
            <a href="/timer"
              ><img
                class="icon sm:w-12 w-8 invert"
                src="/images/clock.png"
                alt=""
            /></a>
          </div>
          <div
            class="app sm:w-20 sm:h-20 w-14 h-14 flex items-center justify-center cursor-pointer home-div rounded-full shadow-md">
            <a href="/board"
              ><img
                class="icon sm:w-12 w-8 invert"
                src="/images/board.png"
                alt=""
            /></a>
          </div>
          <div
            class="app sm:w-20 sm:h-20 w-14 h-14 flex items-center justify-center cursor-pointer home-div rounded-full shadow-md">
            <a href="/notes"
              ><img
                class="icon sm:w-12 w-8 invert"
                src="/images/write.png"
                alt=""
            /></a>
          </div>
          <div
            class="app sm:w-20 sm:h-20 w-14 h-14 flex items-center justify-center cursor-pointer home-div rounded-full shadow-md">
            <a href="/audios"
              ><img
                class="icon sm:w-12 w-8 invert"
                src="/images/audio.png"
                alt=""
            /></a>
          </div>
        </div>
        <div
          class="time num text-4xl sm:text-7xl md:text-9xl font-bold text-dark relative flex sm:gap-10 gap-6 items-center justify-center">
          <div class="hour home-div py-10 lg:px-6 md:px-4 px-6"></div>
          <div class="min home-div py-10 lg:px-6 md:px-4 px-6"></div>
          <div
            class="sec sm:mt-32 mt-16 home-div text-lg sm:py-4 py-2 lg:px-6 md:px-4 px-6"></div>
          <div
            class="line sm:w-[81%] w-[69%] sm:h-2 h-1 absolute second-bg left-0 top-[50%] md:top-[55%]"></div>
          <div class="absolute text-3xl md:text-5xl -top-[10%] left-[28%]">
            TIME
          </div>
          <div class="hout absolute text-lg md:text-2xl bottom-[2%] left-[33%]">
            HOUR
          </div>
        </div>
      </div>
      <div class="calendar text-light home-div p-6 rounded-md w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-3xl">Important Dates</h3>
          <button
            id="toggleForm"
            class="second-bg px-3 py-1 rounded-md text-sm">
            + Add
          </button>
        </div>

        <!-- hidden form -->
        <div id="dateForm" class="flex flex-col gap-2 mb-4 hidden">
          <input
            type="date"
            id="impDate"
            class="p-1 text-sm rounded-md text-black" />
          <textarea
            id="impText"
            rows="2"
            placeholder="Short note..."
            class="p-1 text-sm rounded-md text-black resize-none"></textarea>
          <button
            id="saveDate"
            class="second-bg px-3 py-1 text-sm rounded-md self-start">
            Save
          </button>
        </div>

        <table class="w-full text-left border-collapse text-lg">
          <thead>
            <tr class="border-b">
              <th class="py-2">Date</th>
              <th class="py-2">Note</th>
            </tr>
          </thead>
          <tbody id="dateTable"></tbody>
        </table>
      </div>

      <div class="layout">
        <% user.images.forEach((img, i) => { %>
        <div
          class="image-wrapper"
          data-index="<%= i %>"
          style="background-image: url('<%= img %>')">
          <div class="edit-btn">
            <img src="/images/edit-image.png" class="w-6 h-6 invert" />
          </div>
        </div>
        <% }) %>
      </div>
    </main>

    <%- include("partials/footer") %>

    <script>
      let hr = document.querySelector(".time .hour");
      let min = document.querySelector(".time .min");
      let sec = document.querySelector(".time .sec");

      function showTime() {
        let now = new Date();
        let hours = now.getHours();
        let minutes = now.getMinutes();
        let seconds = now.getSeconds();

        hr.textContent = hours < 10 ? "0" + hours : hours;
        min.textContent = minutes < 10 ? "0" + minutes : minutes;
        sec.textContent = seconds < 10 ? "0" + seconds : seconds;
      }

      setInterval(showTime, 1000);
      showTime();
      const isDarkTheme = localStorage.getItem("theme") === "dark";
      const icons = document.querySelectorAll(".icon");

      icons.forEach((icon) => {
        if (isDarkTheme) {
          icon.classList.remove("invert");
        } else {
          icon.classList.add("invert");
        }
      });
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const wrapper = btn.closest(".image-wrapper");
          const index = wrapper.dataset.index;
          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.accept = "image/*";
          fileInput.click();

          fileInput.onchange = async () => {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("image", file);
            formData.append("index", index);

            const res = await fetch("/update-image", {
              method: "POST",
              body: formData,
            });
            const data = await res.json();

            if (data.success) {
              wrapper.style.backgroundImage = `url('${data.imageUrl}')`;
            }
          };
        });
      });
      const totalTimeEl = document.getElementById("totalTime");

      // get saved total time (in ms)
      let totalTime = parseInt(sessionStorage.getItem("totalTime")) || 0;

      // start time of current session
      let lastTick = Date.now();

      setInterval(() => {
        const now = Date.now();
        const diff = now - lastTick;
        lastTick = now;

        totalTime += diff;

        // save continuously (this is the key fix)
        sessionStorage.setItem("totalTime", totalTime);

        const totalSeconds = Math.floor(totalTime / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;

        totalTimeEl.textContent =
          `${minutes < 10 ? "0" : ""}${minutes}:` +
          `${seconds < 10 ? "0" : ""}${seconds}`;
      }, 1000);
      const dateInput = document.getElementById("impDate");
      const textInput = document.getElementById("impText");
      const saveBtn = document.getElementById("saveDate");
      const tableBody = document.getElementById("dateTable");

      let importantDates =
        JSON.parse(localStorage.getItem("importantDates")) || [];

      function renderDates() {
        tableBody.innerHTML = "";
        importantDates.forEach((item) => {
          const row = document.createElement("tr");
          row.classList.add("border-b");

          row.innerHTML = `
        <td class="py-2">${item.date}</td>
        <td class="py-2">${item.text}</td>
      `;
          tableBody.appendChild(row);
        });
      }

      saveBtn.addEventListener("click", () => {
        if (!dateInput.value || !textInput.value) return;

        importantDates.push({
          date: dateInput.value,
          text: textInput.value,
        });

        localStorage.setItem("importantDates", JSON.stringify(importantDates));

        dateInput.value = "";
        textInput.value = "";

        form.classList.add("hidden");
        renderDates();
      });

      renderDates();
      const toggleBtn = document.getElementById("toggleForm");
      const form = document.getElementById("dateForm");

      toggleBtn.addEventListener("click", () => {
        form.classList.toggle("hidden");
      });

      fetch("http://localhost:3000/api/quote")
        .then((res) => res.json())
        .then((data) => {
          document.querySelector("#quote").innerText = data.quote;
        });
    </script>
  </body>
</html>
