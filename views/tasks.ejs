<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <%- include("partials/navbar") %>
    <main class="first-bg md:p-8 p-4 min-h-[80vh]">
      <form
        class="add my-10 flex justify-center gap-5 items-center w-[80%] mx-auto"
        action="/tasks/create"
        method="post">
        <div class="inputs flex flex-col gap-2 w-[80%]">
          <input
            placeholder="Enter the Timing eg: 8:00 - 8:40"
            name="timing"
            class="bg-transparent rounded-2xl w-full border border-pink-300 focus:outline-pink-500 p-2"
            type="text" />
          <input
            placeholder="Enter the Task eg: Study"
            name="task"
            class="bg-transparent rounded-2xl w-full border border-pink-300 focus:outline-pink-500 p-2"
            type="text" />
        </div>
        <input
          class="btn-bg cursor-pointer text-white px-5 py-2 rounded active:scale-95 transition"
          type="submit"
          value="Submit" />
      </form>

      <div
        class="schedule text board-div rounded-xl p-2 md:p-8 flex justify-start items-center flex-col gap-5 w-[98%] md:w-[80%] m-auto">
        <h2 class="text-5xl text-center font-bold">Daily Schedule</h2>

        <% tasks.forEach(task => {%>
        <div
          class="box relative flex justify-between gap-3 items-center p-2 px-5 w-[98%] md:w-[90%] rounded-2xl border border-[#ffb6d9] shadow-[0_0px_9px_4px_rgba(254,96,191,0.26)]">
          <div
            class="flex flex-col lg:flex-row justify-between items-center w-[80%]">
            <div
              class="bg-transparent w-full focus:outline-pink-500 p-2 font-bold text-xl">
              <%= task.timing %>
            </div>
            <p
              class="text-lg w-full <%= task.isCompleted ? 'line-through' : '' %>">
              <%= task.task %>
            </p>
          </div>

          <input class="task-check relative w-6 h-6 rounded-full appearance-none
          border-2 border-pink-400 check-box checked-check-box cursor-pointer"
          type="checkbox" name="status" id="<%= task._id %>" <%=
          task.isCompleted ? "checked" : "" %>/>
          <img class="w-5 more cursor-pointer" src="/images/more.png" alt="" />
          <div
            class="extra hidden z-20 py-2 px-3 flex flex-col justify-center items-center gap-2 bg-white rounded-xl absolute -bottom-20 right-6">
            <h5
              id="<%= task._id %>"
              class="px-6 edit py-2 rounded-3xl hover-nav-div cursor-pointer">
              Edit
            </h5>
            <h5
              id="<%= task._id %>"
              class="px-6 delete py-2 rounded-3xl hover-nav-div cursor-pointer">
              Delete
            </h5>
          </div>
          <div
            class="edit-box sm:w-[60%] w-full z-20 hidden p-4 rounded-xl second-bg flex gap-2 absolute -bottom-20 left-2">
            <form
              class="flex gap-2 items-center justify-center"
              action="/tasks/edit/<%=task._id%>"
              method="post">
              <input
                placeholder="Enter the Timing eg: 8:00 - 8:40"
                name="timing"
                class="bg-transparent rounded-2xl w-full border border-pink-300 focus:outline-pink-500 p-2"
                type="text"
                value="<%= task.timing %>" />
              <input
                placeholder="Enter the Task eg: Study"
                name="task"
                class="bg-transparent rounded-2xl w-full border border-pink-300 focus:outline-pink-500 p-2"
                type="text"
                value="<%= task.task %>" />
              <input
                class="w-8 h-8 text-white flex-shrink-0 rounded-full nav-div flex justify-center items-center cursor-pointer"
                type="submit"
                value="âœ”" />
            </form>
          </div>
        </div>
        <% }); %>
      </div>
    </main>
    <%- include("partials/footer") %>
    <script>
      let moreBtns = document.querySelectorAll(".more");
      let checkboxes = document.querySelectorAll(".task-check");
      let deletes = document.querySelectorAll(".delete");
      let edits = document.querySelectorAll(".edit");
      moreBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          let parentBox = btn.closest(".box");
          let extra = parentBox.querySelector(".extra");
          extra.classList.toggle("hidden");
        });
      });

      checkboxes.forEach((e) => {
        e.addEventListener("change", async (event) => {
          let id = event.target.id;

          await fetch(`/tasks/status/${id}`, {
            method: "POST",
          });
          location.reload();
        });
      });
      deletes.forEach((e) => {
        e.addEventListener("click", async (event) => {
          let id = event.target.id;

          await fetch(`/tasks/delete/${id}`, {
            method: "POST",
          });
          location.reload();
        });
      });
      edits.forEach((editBtn) => {
        editBtn.addEventListener("click", (event) => {
          let parentBox = event.target.closest(".box");
          let editBox = parentBox.querySelector(".edit-box");

          parentBox.querySelector(".extra").classList.add("hidden");

          editBox.classList.toggle("hidden");
        });
      });
      document.addEventListener("click", (e) => {
        let clickedInsideBox = e.target.closest(".box");

        if (!clickedInsideBox) {
          document
            .querySelectorAll(".extra")
            .forEach((extra) => extra.classList.add("hidden"));
          document
            .querySelectorAll(".edit-box")
            .forEach((editBox) => editBox.classList.add("hidden"));
        }
      });
    </script>
  </body>
</html>
